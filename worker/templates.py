"""
Template rendering for agent reports and PR descriptions
"""

import os
import json
from datetime import datetime
from typing import Dict, Any, Optional, List

def render_progress_panel(issue_number: int, actor: str, job_id: str, 
                         initialized: bool = False, locate: bool = False, 
                         propose: bool = False, fix: bool = False, 
                         verify: bool = False, ready: bool = False) -> str:
    """Render PR progress panel with enhanced visual design"""
    
    def stage_status(completed: bool, in_progress: bool = False) -> str:
        if completed:
            return 'âœ…'
        elif in_progress:
            return 'ðŸ”„'
        else:
            return 'â³'
    
    # Determine current stage for in-progress indicator
    current_stage = None
    if not locate:
        current_stage = 'locate'
    elif not propose:
        current_stage = 'propose'  
    elif not fix:
        current_stage = 'fix'
    elif not verify:
        current_stage = 'verify'
    elif not ready:
        current_stage = 'ready'
    
    panel = f"""## ðŸ¤– GitCode Bug Fix Agent - å¤„ç†è¿›åº¦

### ðŸ“Š å®žæ—¶è¿›åº¦è·Ÿè¸ª

| é˜¶æ®µ | çŠ¶æ€ | æè¿° | å®Œæˆæ—¶é—´ |
|------|------|------|----------|
| ðŸ” **é—®é¢˜å®šä½** | {stage_status(locate, current_stage == 'locate')} | æ·±åº¦åˆ†æžé—®é¢˜ï¼Œè¯†åˆ«ç›¸å…³æ–‡ä»¶ | {'âœ“' if locate else '-'} |
| ðŸ’¡ **æ–¹æ¡ˆè®¾è®¡** | {stage_status(propose, current_stage == 'propose')} | åˆ¶å®šè¯¦ç»†ä¿®å¤ç­–ç•¥å’Œè®¡åˆ’ | {'âœ“' if propose else '-'} |
| ðŸ› ï¸ **ä»£ç ä¿®æ”¹** | {stage_status(fix, current_stage == 'fix')} | å®žæ–½ä»£ç ä¿®å¤å’Œä¼˜åŒ– | {'âœ“' if fix else '-'} |
| âœ… **éªŒè¯æµ‹è¯•** | {stage_status(verify, current_stage == 'verify')} | åŠŸèƒ½æµ‹è¯•å’Œè´¨é‡éªŒè¯ | {'âœ“' if verify else '-'} |
| ðŸŽ¯ **å‡†å¤‡å®Œæˆ** | {stage_status(ready, current_stage == 'ready')} | ä¿®å¤å®Œæˆï¼Œå‡†å¤‡ä»£ç å®¡æŸ¥ | {'âœ“' if ready else '-'} |

### ðŸ“‹ ä»»åŠ¡è¯¦æƒ…

```
ðŸ“ Issueç¼–å·    : #{issue_number}
ðŸ‘¤ è§¦å‘ç”¨æˆ·     : @{actor}  
ðŸ†” ä»»åŠ¡ID      : {job_id}
â° åˆ›å»ºæ—¶é—´     : {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC
ðŸ”„ å½“å‰çŠ¶æ€     : {'ðŸŽ‰ å¤„ç†å®Œæˆ' if ready else f'ðŸ”„ æ­£åœ¨{current_stage}é˜¶æ®µ' if current_stage else 'ðŸš€ å¯åŠ¨ä¸­'}
```

### ðŸ“ ç”Ÿæˆçš„æ–‡æ¡£å’ŒæŠ¥å‘Š

{('âœ…' if locate else 'â³')} **`agent/analysis.md`** - é—®é¢˜è¯Šæ–­å’Œæ ¹å› åˆ†æžæŠ¥å‘Š
{('âœ…' if propose else 'â³')} **`agent/patch_plan.json`** - å®Œæ•´ä¿®å¤ç­–ç•¥å’Œå®žæ–½è®¡åˆ’  
{('âœ…' if verify else 'â³')} **`agent/report.txt`** - éªŒè¯æµ‹è¯•ç»“æžœå’Œè´¨é‡æŠ¥å‘Š

### ðŸš€ AIé©±åŠ¨çš„æ™ºèƒ½ä¿®å¤

- **ðŸ§  AIåˆ†æž**: ä½¿ç”¨å¤§è¯­è¨€æ¨¡åž‹è¿›è¡Œæ·±åº¦é—®é¢˜åˆ†æž
- **ðŸŽ¯ ç²¾å‡†å®šä½**: æ™ºèƒ½è¯†åˆ«é—®é¢˜æ–‡ä»¶å’Œä¿®å¤ç‚¹
- **ðŸ›¡ï¸ è´¨é‡ä¿è¯**: ç¡®ä¿ä¿®å¤æ–¹æ¡ˆçš„å®‰å…¨æ€§å’Œå…¼å®¹æ€§
- **ðŸ“Š å…¨ç¨‹è¿½è¸ª**: æ¯ä¸ªé˜¶æ®µéƒ½æœ‰è¯¦ç»†è¿›åº¦åé¦ˆ

---
*ï¿½ æœ¬ä¿®å¤ç”± [GitCode Bug Fix Agent](https://gitcode.com) è‡ªåŠ¨ç”Ÿæˆ*
*ðŸ’¬ å¦‚æœ‰ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·åœ¨Issueæˆ–PRä¸­ç•™è¨€åé¦ˆ*"""
    
    return panel

def render_analysis(issue_title: str, issue_body: str, candidate_files: Optional[List[str]] = None) -> str:
    """Render analysis.md template"""
    
    if not candidate_files:
        candidate_files = ["src/main.py", "src/utils.py", "README.md"]
    
    analysis = f"""# Agent Analysis Report

## Issue Summary
**Title:** {issue_title}

**Description:**
{issue_body}

## Analysis Results (Demo)

### Candidate Files
Based on issue analysis, these files are likely related to the problem:

"""
    
    for i, file_path in enumerate(candidate_files, 1):
        analysis += f"{i}. `{file_path}` - Potential fix location\n"
    
    analysis += f"""
### Analysis Method
- Keyword matching in issue description
- File structure analysis  
- Recent changes review (simulated)

### Confidence Level
ðŸŸ¡ **Medium** (Demo mode - using pattern matching)

---
Generated by Agent at {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC
"""
    
    return analysis

def render_patch_plan(issue_title: str, target_files: Optional[List[str]] = None) -> str:
    """Render patch_plan.json template"""
    
    if not target_files:
        target_files = ["README.md"]
    
    plan = {
        "patch_plan": {
            "issue_title": issue_title,
            "generated_at": datetime.utcnow().isoformat(),
            "strategy": "demo_safe_patch",
            "patches": []
        }
    }
    
    for file_path in target_files:
        if "README" in file_path.upper():
            patch = {
                "file": file_path,
                "type": "append",
                "description": "Add agent fix demo section",
                "content": "Agent demo fix applied",
                "risk_level": "low",
                "reversible": True
            }
        else:
            patch = {
                "file": file_path,
                "type": "modify",
                "description": f"Apply fix to {file_path}",
                "content": "# Agent demo modification",
                "risk_level": "low", 
                "reversible": True
            }
        
        plan["patch_plan"]["patches"].append(patch)
    
    return json.dumps(plan, indent=2, ensure_ascii=False)

def render_report(build_success: bool = True, test_results: Optional[Dict[str, Any]] = None, 
                 deploy_url: Optional[str] = None) -> str:
    """Render report.txt template"""
    
    if not test_results:
        test_results = {
            "passed": 42,
            "failed": 0,
            "skipped": 3,
            "coverage": "0% (demo)"
        }
    
    if not deploy_url:
        import uuid
        deploy_id = str(uuid.uuid4())[:8]
        deploy_url = f"https://demo.agent-fix.example/{deploy_id}"
    
    report = f"""# Agent Verification Report

## Build Status
âœ… **SUCCESS** - Build completed successfully (demo)

## Test Results  
ðŸ“Š **Test Summary:**
- Passed: {test_results['passed']}
- Failed: {test_results['failed']}
- Skipped: {test_results['skipped']}
- Coverage: {test_results['coverage']}

## Demo Deployment
ðŸš€ **Deployment URL:** {deploy_url}
ðŸ“… **Deployed at:** {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC

## Verification Steps
1. âœ… Code compilation check
2. âœ… Syntax validation  
3. âœ… Demo test execution
4. âœ… Deployment simulation

---
*Note: This is a demonstration environment*
Report generated at {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC
"""
    
    return report

def render_deploy_info(deploy_url: str) -> str:
    """Render deployment information"""
    
    deploy_info = f"""

## Deployment Update
ðŸŽ¯ **Live Demo:** {deploy_url}
âš¡ **Status:** Active (demo environment)
ðŸ”— **Valid until:** {datetime.utcnow().strftime('%Y-%m-%d')} (24h demo)

"""
    return deploy_info
